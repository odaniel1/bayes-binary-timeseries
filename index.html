<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Bayesian methods for binary timeseries</title>

<link href="site_libs/tint-css-2015.12.29/tint.css" rel="stylesheet" />
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








</head>

<body>




<h1 class="title toc-ignore">Bayesian methods for binary timeseries</h1>


<div id="TOC">
<ul>
<li><a href="#the-data">The Data</a></li>
<li><a href="#non-bayesian-methods">Non-Bayesian Methods</a><ul>
<li><a href="#aggregated-binomial-proportions">(Aggregated) Binomial proportions</a></li>
<li><a href="#loess-smoothing">Loess Smoothing</a></li>
<li><a href="#binary-arima">Binary ARIMA</a></li>
</ul></li>
<li><a href="#bayesian-approaches">Bayesian Approaches</a><ul>
<li><a href="#hierarchical-logistic-regression">Hierarchical logistic regression</a></li>
<li><a href="#propogating-priors">Propogating Priors</a></li>
</ul></li>
</ul>
</div>

<style>
.math {
  font-size: 12pt;
}
</style>
<p><label for="tufte-mn-1" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-1" class="margin-toggle"><span class="marginnote">Binary data often also arises through a process of simplifying analysis: eg. replacing a question which could be on a continuous scale, with a cut-off: for instance, analysis of exam pass/fail rates is a simpler problem to explore than the full distribution of exam marks</span></p>
<p>Binary data occurs in many natural settings where we wish to understand the relative likelihood of one of two outcomes occuring (often referred to as failure <span class="math inline">\(0\)</span> and success). For instance whether or not a newborn child is a boy or a girl (in this context, one might be cautioned against the failure/success terminology).</p>
<p>The natural statistic of interest for binary questions is the underlying proportion of successes. Given a sample of <span class="math inline">\(n\)</span> observations with <span class="math inline">\(0 \leq s \leq n\)</span> successes, the classical (maximum likelihood) estimate for the success rate is simply <span class="math inline">\(s/n\)</span>, the proportion of the observed data that were successes.</p>
<p><label for="tufte-mn-2" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-2" class="margin-toggle"><span class="marginnote"><a href="http://varianceexplained.org/r/empirical-bayes-book/">Robinson’s</a> introduction to Empirical Bayes through baseball statistics is an excellent resource for learning the basics of binary inference. Unfortunately it does not explore timeseries.</span> In many instances it is likely that this binary data makes up a timeseries: for example in baseball, the proportion of hits a player makes out of all balls they are thrown (apparently known as <em>At Bats</em>). In this context we would expect this proportion to vary over time - both due to game specific covariates (eg. who pitched the ball), and temporal affects (eg. improving performance with experience).</p>
<p>In such applications any underlying success rate at a given point in time is likely to be correlated with success rates within the recent past and future. Estimates for the success rate that do not take into account this correlation will therefore likely be overly susceptible to natural variance.</p>
<p>Our focus will be on exploring methods for analysing binary time series under two challenging conditions:</p>
<ul>
<li><p>Where the number of observations at each time point is low - meaning that estimates of success rates which don’t take into account nearby observtaions are likely to be too broad to provide insight.</p></li>
<li><p>Where data does not arrive at routine intervals - meaning that methods that are based on differencing/neighbouring statistics are not very easy to define.</p></li>
</ul>
<div id="the-data" class="section level1">
<h1>The Data</h1>
<p><label for="tufte-mn-3" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-3" class="margin-toggle"><span class="marginnote">Data is made available through the <a href="https://api.stackexchange.com/docs">Stack Exchange API</a>; this can be queried in R usnig the <a href="https://github.com/dgrtwo/stackr">stackr</a> package - coincidentally written by the same David Robinson referenced above.</span> For an open source data set that exhibits the features defined above, we consider the acceptance rate of answers to <a href="https://stackexchange.com/">Stack Exchange</a> questions. In particular we will look at the data of a single user <a href="https://stats.stackexchange.com/users/7224/xian">Xi’an</a> on Cross Validated (stats.stackexchange) who is at the time of writing the top ranked user for the Bayesian tag.</p>
<pre class="r"><code>library(stackr) # devtools::install_github(&quot;https://github.com/dgrtwo/stackr&quot;)
library(tidyverse)
library(lubridate)

dat &lt;- stack_users(id =  7224, &quot;answers&quot;,
                   site = &quot;stats.stackexchange.com&quot;,
                   pagesize = 100, num_pages = 20) %&gt;%
  
  # summarise by date
  mutate(date = trunc(creation_date, unit = &quot;day&quot;) %&gt;% as.Date()) %&gt;%
  group_by(date) %&gt;%
  summarise(
    answered = n(),
    accepted = sum(is_accepted)
  ) %&gt;%
  ungroup()</code></pre>
<p>
<span class="marginnote shownote"><!--
<div class="figure">--> <img src="index_files/figure-html/unnamed-chunk-2-1.png" alt="The number of questions answered in March 2020 illustrates that the data shows both low volumes, and intermittent frequency" width="480"  /> <!--
<p class="caption marginnote">-->The number of questions answered in March 2020 illustrates that the data shows both low volumes, and intermittent frequency<!--</p>--> <!--</div>--></span>
</p>
<p>A sample of the first 6 rows of the data are shown below; for the most part we work with data that is aggregated to a daily level - we will however consider one model that looks at variation within days at the end.</p>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
date
</th>
<th style="text-align:right;">
answered
</th>
<th style="text-align:right;">
accepted
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
2011-11-05
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
2011-11-07
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
2011-11-11
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
2011-11-13
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
2011-11-19
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
2011-11-24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<div id="non-bayesian-methods" class="section level1">
<h1>Non-Bayesian Methods</h1>
<div id="aggregated-binomial-proportions" class="section level2">
<h2>(Aggregated) Binomial proportions</h2>
<p>Likely the first work around one might look to apply is to further aggregate the data, eg. up to monthly views. Even at this level the volume of data remains sufficiently low as to render the estimated acceptance rates useless.</p>
<p>
<span class="marginnote shownote"><!--
<div class="figure">--> <img src="index_files/figure-html/unnamed-chunk-4-1.png" alt=" " width="672"  /> <!--
<p class="caption marginnote">--> <!--</p>--> <!--</div>--></span>
</p>
<pre class="r"><code>dat_monthly &lt;- dat %&gt;%
  group_by(date= floor_date(date, unit = &quot;month&quot;) ) %&gt;%
  summarise_all( ~sum(.))

naive_monthly_model &lt;- dat_monthly %&gt;%
  mutate(
    p_mle  =  accepted/answered,
    lwr_80 = qnorm(0.1, mean = p_mle, sd = sqrt( p_mle * (1-p_mle)/answered)),
    upr_80 = qnorm(0.9, mean = p_mle, sd = sqrt( p_mle * (1-p_mle)/answered))
)

ggplot(naive_monthly_model, aes(date, p_mle)) + geom_line() +
  geom_ribbon(aes(date,ymin = lwr_80, ymax = upr_80), alpha = 0.2)</code></pre>
</div>
<div id="loess-smoothing" class="section level2">
<h2>Loess Smoothing</h2>
</div>
<div id="binary-arima" class="section level2">
<h2>Binary ARIMA</h2>
</div>
</div>
<div id="bayesian-approaches" class="section level1">
<h1>Bayesian Approaches</h1>
<div id="hierarchical-logistic-regression" class="section level2">
<h2>Hierarchical logistic regression</h2>
<p>
<span class="marginnote shownote"><!--
<div class="figure">--> <img src="index_files/figure-html/unnamed-chunk-5-1.png" alt=" " width="672"  /> <!--
<p class="caption marginnote">--> <!--</p>--> <!--</div>--></span>
</p>
<pre class="r"><code>library(rstan)
library(rstanarm)
library(tidybayes)

naive_hb_fit &lt;- stan_glmer(cbind(accepted,answered-accepted) ~1 + (1|date),data = dat_monthly, 
                 family = binomial(link = &quot;logit&quot;))

naive_hb_model &lt;- naive_hb_fit %&gt;%
  spread_draws(`(Intercept)`, b[,date]) %&gt;%
  mode_qi(mode = `(Intercept)` + b, .width = 0.8) %&gt;%
  mutate(
    date = str_remove(date, &quot;date:&quot;) %&gt;% as.Date(),
    p_mode = plogis(mode),
    lwr_80 = plogis(.lower),
    upr_80 = plogis(.upper)
  )
  
ggplot(naive_hb_model, aes(date, p_mode)) + geom_line() +
  geom_ribbon(aes(date,ymin = lwr_80, ymax = upr_80), alpha = 0.2)  </code></pre>
</div>
<div id="propogating-priors" class="section level2">
<h2>Propogating Priors</h2>
<p>
<span class="marginnote shownote"><!--
<div class="figure">--> <img src="index_files/figure-html/unnamed-chunk-6-1.png" alt=" " width="672"  /> <!--
<p class="caption marginnote">--> <!--</p>--> <!--</div>--></span>
</p>
<pre class="r"><code>prior_prop &lt;- dat %&gt;%
  mutate(
    alpha = cumsum(accepted) +1/2,
    beta  = cumsum(answered) - cumsum(accepted) + 1/2,
    p_mode = alpha/(alpha + beta),
    lwr_80 = qbeta(0.1, alpha, beta),
    upr_80 = qbeta(0.9, alpha, beta)
  )

ggplot(prior_prop, aes(date, p_mode)) + geom_line() +
  geom_ribbon(aes(date,ymin = lwr_80, ymax = upr_80), alpha = 0.2)  </code></pre>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
